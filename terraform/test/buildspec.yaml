version: 0.2

env:
  variables:
      keystore: "cloud-platform-test-cluster-keystore"
      cluster: "cloud-platforms-test.k8s.integration.dsd.io"

phases:
  install:
    commands:
       - "apt update"
       - "apt install -y awscli git python3"
       - "wget https://github.com/kubernetes/kops/releases/download/1.8.0/kops-linux-amd64"
       - "chmod +x kops-linux-amd64"
       - "mv kops-linux-amd64 /usr/local/bin/kops"
       - "curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
       - "chmod +x kubectl"
       - "mv ./kubectl /usr/local/bin/kubectl"
       - "wget https://storage.googleapis.com/kubernetes-helm/helm-v2.8.2-linux-amd64.tar.gz -O helm.tar.gz; tar -xzf helm.tar.gz"
       - "chmod +x ./linux-amd64/helm"
       - "mv ./linux-amd64/helm /usr/local/bin/helm"
  pre_build:
    commands:
      - "mkdir ~/.kube/"
      - "aws s3 cp s3://$keystore/kubecfg.yaml ~/.kube/config" 
  build:
    commands:
      - "kubectl config get-contexts"
      - "kubectl config use-context $cluster"
      - "kubectl cluster-info"
      - "kubectl get namespaces"
      - "kubectl get pods --all-namespaces"
      - "which python3"
      - "python3 namespace.py -c $cluster"
